@page "/usertasks"
@using BlazorAppMaybePoc.Shared
@inject HttpClient Http

<div class="container">
    <h1>User Tasks</h1>
    <div class="mb-3">
        <label for="userId" class="form-label">User ID:</label>
        <input id="userId" @bind="userId" type="text" class="form-control" style="width:auto; display:inline-block;"/>
        <button @onclick="LoadTasks" class="btn btn-primary">Load Tasks</button>
    </div>

    @if (toDoItems is not null)
    {
        <table class="table table-striped">
            <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>
                    <button class="btn" @onclick="() => SortTasks(nameof(ToDoItem.DueDate))">
                        Due Date
                        <i class="bi @(primarySortColumn == nameof(ToDoItem.DueDate) ? (sortAscending ? "bi-chevron-expand" : "bi-chevron-contract") : "bi-sort-alpha-down")"></i>
                    </button>
                </th>
                <th>
                    <button class="btn" @onclick="() => SortTasks(nameof(ToDoItem.Priority))">
                        Priority
                        <i class="bi @(primarySortColumn == nameof(ToDoItem.Priority) ? (sortAscending ? "bi-chevron-expand" : "bi-chevron-contract") : "bi-sort-alpha-down")"></i>
                    </button>
                </th>
                <th>
                    <button class="btn" @onclick="() => SortTasks(nameof(ToDoItem.Status))">
                        Status
                        <i class="bi @(primarySortColumn == nameof(ToDoItem.Status) ? (sortAscending ? "bi-chevron-expand" : "bi-chevron-contract") : "bi-sort-alpha-down")"></i>
                    </button>
                </th>
            </tr>
            </thead>
            <tbody>
            @foreach (var item in toDoItems)
            {
                <tr>
                    <td>@item.Title</td>
                    <td>@item.Description</td>
                    <td>@item.DueDate.ToShortDateString()</td>
                    <td>@item.Priority</td>
                    <td>@item.Status</td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

@code {
    private string userId = "1";
    private IEnumerable<ToDoItem> toDoItems;
    private string primarySortColumn = nameof(ToDoItem.Priority);
    private string secondarySortColumn = nameof(ToDoItem.DueDate);
    private bool sortAscending = true;

    private async Task LoadTasks()
    {
        await SortTasks(primarySortColumn);
    }

    private async Task SortTasks(string column)
    {
        if (primarySortColumn == column)
        {
            sortAscending = !sortAscending; // Toggle sort order if the same column was clicked again
        }
        else
        {
    // Set the secondary sort column to the previous primary, and make the clicked column the new primary
            secondarySortColumn = primarySortColumn;
            primarySortColumn = column;
            sortAscending = true; // Reset sort order to ascending when changing columns
        }

        await FetchSortedData();
    }

    private async Task FetchSortedData()
    {
        var url = $"ToDoItem/user/{userId}?primarySortColumn={primarySortColumn}&secondarySortColumn={secondarySortColumn}&sortAscending={sortAscending}";
        var response = await Http.GetAsync(url);
        toDoItems = await response.Content.ReadFromJsonAsync<IEnumerable<ToDoItem>>();
    }

}
